<!DOCTYPE html><html><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>cc.audio.dfpwm</title><meta property="og:title" content="cc.audio.dfpwm" /><meta property="og:type" content="website" /><meta name="description" content="Convert between streams of DFPWM audio data and a list of amplitudes." /><meta property="og:description" content="Convert between streams of DFPWM audio data and a list of amplitudes." /><meta property="og:image" content="https://devvie.cc/docs/cc/pack.png" /><meta property="og:site_name" content="CC: Tweaked" /><meta name="illuaminate:index" content="../index.json" /><link rel="stylesheet" href="../main.css?v=5ab962eb" type="text/css" /><!--
SPDX-FileCopyrightText: 2020 The CC: Tweaked Developers

SPDX-License-Identifier: MPL-2.0
-->

<meta name="theme-color" content="#c8d87c"></head><body><nav id="nav"><button id="nav-reveal" type="button">&#9776;</button><h1><a href=".././"><img src="../pack.png" alt="CC: Tweaked" /></a></h1><div class="nav-links"><h2 tabindex="0">Contents</h2><ul><li><a href="#v:make_encoder" class="sidebar-link">make_encoder</a></li><li><a href="#v:encode" class="sidebar-link">encode</a></li><li><a href="#v:make_decoder" class="sidebar-link">make_decoder</a></li><li><a href="#v:decode" class="sidebar-link">decode</a></li></ul><h2 class="collapsed" tabindex="0">Globals</h2><ul><li><a href="../module/_G.html" class="sidebar-link">_G</a></li><li><a href="../module/colors.html" class="sidebar-link">colors</a></li><li><a href="../module/colours.html" class="sidebar-link">colours</a></li><li><a href="../module/commands.html" class="sidebar-link">commands</a></li><li><a href="../module/disk.html" class="sidebar-link">disk</a></li><li><a href="../module/fs.html" class="sidebar-link">fs</a></li><li><a href="../module/gps.html" class="sidebar-link">gps</a></li><li><a href="../module/help.html" class="sidebar-link">help</a></li><li><a href="../module/http.html" class="sidebar-link">http</a></li><li><a href="../module/io.html" class="sidebar-link">io</a></li><li><a href="../module/keys.html" class="sidebar-link">keys</a></li><li><a href="../module/multishell.html" class="sidebar-link">multishell</a></li><li><a href="../module/os.html" class="sidebar-link">os</a></li><li><a href="../module/paintutils.html" class="sidebar-link">paintutils</a></li><li><a href="../module/parallel.html" class="sidebar-link">parallel</a></li><li><a href="../module/peripheral.html" class="sidebar-link">peripheral</a></li><li><a href="../module/rednet.html" class="sidebar-link">rednet</a></li><li><a href="../module/settings.html" class="sidebar-link">settings</a></li><li><a href="../module/shell.html" class="sidebar-link">shell</a></li><li><a href="../module/term.html" class="sidebar-link">term</a></li><li><a href="../module/textutils.html" class="sidebar-link">textutils</a></li><li><a href="../module/turtle.html" class="sidebar-link">turtle</a></li><li><a href="../module/vector.html" class="sidebar-link">vector</a></li><li><a href="../module/window.html" class="sidebar-link">window</a></li></ul><h2 tabindex="0">Modules</h2><ul><li><strong class="sidebar-link selected">cc.audio.dfpwm</strong></li><li><a href="cc.completion.html" class="sidebar-link">cc.completion</a></li><li><a href="cc.expect.html" class="sidebar-link">cc.expect</a></li><li><a href="cc.image.nft.html" class="sidebar-link">cc.image.nft</a></li><li><a href="cc.pretty.html" class="sidebar-link">cc.pretty</a></li><li><a href="cc.require.html" class="sidebar-link">cc.require</a></li><li><a href="cc.shell.completion.html" class="sidebar-link">cc.shell.completion</a></li><li><a href="cc.strings.html" class="sidebar-link">cc.strings</a></li></ul><h2 class="collapsed" tabindex="0">Events</h2><ul><li><a href="../event/alarm.html" class="sidebar-link">alarm</a></li><li><a href="../event/char.html" class="sidebar-link">char</a></li><li><a href="../event/computer_command.html" class="sidebar-link">computer_command</a></li><li><a href="../event/disk.html" class="sidebar-link">disk</a></li><li><a href="../event/disk_eject.html" class="sidebar-link">disk_eject</a></li><li><a href="../event/file_transfer.html" class="sidebar-link">file_transfer</a></li><li><a href="../event/http_check.html" class="sidebar-link">http_check</a></li><li><a href="../event/http_failure.html" class="sidebar-link">http_failure</a></li><li><a href="../event/http_success.html" class="sidebar-link">http_success</a></li><li><a href="../event/key.html" class="sidebar-link">key</a></li><li><a href="../event/key_up.html" class="sidebar-link">key_up</a></li><li><a href="../event/modem_message.html" class="sidebar-link">modem_message</a></li><li><a href="../event/monitor_resize.html" class="sidebar-link">monitor_resize</a></li><li><a href="../event/monitor_touch.html" class="sidebar-link">monitor_touch</a></li><li><a href="../event/mouse_click.html" class="sidebar-link">mouse_click</a></li><li><a href="../event/mouse_drag.html" class="sidebar-link">mouse_drag</a></li><li><a href="../event/mouse_scroll.html" class="sidebar-link">mouse_scroll</a></li><li><a href="../event/mouse_up.html" class="sidebar-link">mouse_up</a></li><li><a href="../event/paste.html" class="sidebar-link">paste</a></li><li><a href="../event/peripheral.html" class="sidebar-link">peripheral</a></li><li><a href="../event/peripheral_detach.html" class="sidebar-link">peripheral_detach</a></li><li><a href="../event/rednet_message.html" class="sidebar-link">rednet_message</a></li><li><a href="../event/redstone.html" class="sidebar-link">redstone</a></li><li><a href="../event/speaker_audio_empty.html" class="sidebar-link">speaker_audio_empty</a></li><li><a href="../event/task_complete.html" class="sidebar-link">task_complete</a></li><li><a href="../event/term_resize.html" class="sidebar-link">term_resize</a></li><li><a href="../event/terminate.html" class="sidebar-link">terminate</a></li><li><a href="../event/timer.html" class="sidebar-link">timer</a></li><li><a href="../event/turtle_inventory.html" class="sidebar-link">turtle_inventory</a></li><li><a href="../event/websocket_closed.html" class="sidebar-link">websocket_closed</a></li><li><a href="../event/websocket_failure.html" class="sidebar-link">websocket_failure</a></li><li><a href="../event/websocket_message.html" class="sidebar-link">websocket_message</a></li><li><a href="../event/websocket_success.html" class="sidebar-link">websocket_success</a></li></ul><h2 class="collapsed" tabindex="0">Guides</h2><ul><li><a href="../guide/gps_setup.html" class="sidebar-link">Setting up GPS</a></li><li><a href="../guide/local_ips.html" class="sidebar-link">Allowing access to local IPs</a></li><li><a href="../guide/speaker_audio.html" class="sidebar-link">Playing audio with speakers</a></li><li><a href="../guide/using_require.html" class="sidebar-link">Reusing code with require</a></li></ul><h2 class="collapsed" tabindex="0">Reference</h2><ul><li><a href="../reference/feature_compat.html" class="sidebar-link">Lua 5.2/5.3 features in CC: Tweaked</a></li></ul></div></nav><div id="main"><div id="search-form" role="form"><input id="search-box" type="text" placeholder="Search..." autocomplete="off" tabindex="0"></input><div id="search-results"></div></div><section id="content"><h1>cc.audio.dfpwm</h1><p>Convert between streams of DFPWM audio data and a list of amplitudes.</p>
<p>DFPWM (Dynamic Filter Pulse Width Modulation) is an audio codec designed by GreaseMonkey. It's a relatively compact
format compared to raw PCM data, only using 1 bit per sample, but is simple enough to simple enough to encode and decode
in real time.</p>
<p>Typically DFPWM audio is read from <span class="reference reference-unresolved">the filesystem</span> or a <span class="reference reference-unresolved">a web request</span> as a
string, and converted a format suitable for <span class="reference reference-unresolved"><code>speaker.playAudio</code></span>.</p>
<h2>Encoding and decoding files</h2>
<p>This modules exposes two key functions, <a href="cc.audio.dfpwm.html#v:make_decoder" class="reference"><code>make_decoder</code></a> and <a href="cc.audio.dfpwm.html#v:make_encoder" class="reference"><code>make_encoder</code></a>, which construct a new decoder or encoder.
The returned encoder/decoder is itself a function, which converts between the two kinds of data.</p>
<p>These encoders and decoders have lots of hidden state, so you should be careful to use the same encoder or decoder for
a specific audio stream. Typically you will want to create a decoder for each stream of audio you read, and an encoder
for each one you write.</p>
<h2>Converting audio to DFPWM</h2>
<p>DFPWM is not a popular file format and so standard audio processing tools will not have an option to export to it.
Instead, you can convert audio files online using <a href="https://music.madefor.cc/" title="DFPWM audio converter for Computronics and CC: Tweaked">music.madefor.cc</a>, the <a href="https://github.com/gamax92/LionRay/" title="LionRay Wav Converter ">LionRay Wav Converter</a> Java
application or development builds of <a href="https://ffmpeg.org" title="FFmpeg command-line audio manipulation library">FFmpeg</a>.</p>
<h3>Usage</h3><ul><li><p>Reads &quot;data/example.dfpwm&quot; in chunks, decodes them and then doubles the speed of the audio. The resulting audio
is then re-encoded and saved to &quot;speedy.dfpwm&quot;. This processed audio can then be played with the <code>speaker</code> program.</p>
<pre class="highlight" data-lua-kind="stmt"><span class="keyword">local</span> <a title="Convert between streams of DFPWM audio data and a list of amplitudes." href="cc.audio.dfpwm.html"><span class="ident">dfpwm</span> </a><span class="symbol">=</span> <span class="ident">require</span><span class="symbol">(</span><span class="string">"cc.audio.dfpwm"</span><span class="symbol">)</span>

<span class="keyword">local</span> <span class="ident">encoder</span> <span class="symbol">=</span> <a title="Create a new encoder for converting PCM audio data into DFPWM." href="cc.audio.dfpwm.html#v:make_encoder"><span class="ident">dfpwm</span><span class="symbol">.</span><span class="symbol">make_encoder</span></a><span class="symbol">(</span><span class="symbol">)</span>
<span class="keyword">local</span> <span class="ident">decoder</span> <span class="symbol">=</span> <a title="Create a new decoder for converting DFPWM into PCM audio data." href="cc.audio.dfpwm.html#v:make_decoder"><span class="ident">dfpwm</span><span class="symbol">.</span><span class="symbol">make_decoder</span></a><span class="symbol">(</span><span class="symbol">)</span>

<span class="keyword">local</span> <span class="ident">out</span> <span class="symbol">=</span> <a href="../module/fs.html"><span class="ident">fs</span></a><span class="symbol">.</span><span class="symbol">open</span><span class="symbol">(</span><span class="string">"speedy.dfpwm"</span><span class="symbol">,</span> <span class="string">"wb"</span><span class="symbol">)</span>
<span class="keyword">for</span> <span class="ident">input</span> <span class="keyword">in</span> <a title="Opens the given file name in read mode and returns an iterator that, each time it is called, returns a new line from the file." href="../module/io.html#v:lines"><span class="ident">io</span><span class="symbol">.</span><span class="symbol">lines</span></a><span class="symbol">(</span><span class="string">"data/example.dfpwm"</span><span class="symbol">,</span> <span class="number">16</span> <span class="symbol">*</span> <span class="number">1024</span> <span class="symbol">*</span> <span class="number">2</span><span class="symbol">)</span> <span class="keyword">do</span>
  <span class="keyword">local</span> <span class="ident">decoded</span> <span class="symbol">=</span> <span class="ident">decoder</span><span class="symbol">(</span><span class="ident">input</span><span class="symbol">)</span>
  <span class="keyword">local</span> <span class="ident">output</span> <span class="symbol">=</span> <span class="symbol">{</span><span class="symbol">}</span>

  <span class="comment">-- Read two samples at once and take the average.</span>
  <span class="keyword">for</span> <span class="ident">i</span> <span class="symbol">=</span> <span class="number">1</span><span class="symbol">,</span> <span class="symbol">#</span><span class="ident">decoded</span><span class="symbol">,</span> <span class="number">2</span> <span class="keyword">do</span>
    <span class="keyword">local</span> <span class="ident">value_1</span><span class="symbol">,</span> <span class="ident">value_2</span> <span class="symbol">=</span> <span class="ident">decoded</span><span class="symbol">[</span><span class="ident">i</span><span class="symbol">]</span><span class="symbol">,</span> <span class="ident">decoded</span><span class="symbol">[</span><span class="ident">i</span> <span class="symbol">+</span> <span class="number">1</span><span class="symbol">]</span>
    <span class="ident">output</span><span class="symbol">[</span><span class="symbol">(</span><span class="ident">i</span> <span class="symbol">+</span> <span class="number">1</span><span class="symbol">)</span> <span class="symbol">/</span> <span class="number">2</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="symbol">(</span><span class="ident">value_1</span> <span class="symbol">+</span> <span class="ident">value_2</span><span class="symbol">)</span> <span class="symbol">/</span> <span class="number">2</span>
  <span class="keyword">end</span>

  <span class="ident">out</span><span class="symbol">.</span><span class="symbol">write</span><span class="symbol">(</span><span class="ident">encoder</span><span class="symbol">(</span><span class="ident">output</span><span class="symbol">)</span><span class="symbol">)</span>

  <span class="ident">sleep</span><span class="symbol">(</span><span class="number">0</span><span class="symbol">)</span> <span class="comment">-- This program takes a while to run, so we need to make sure we yield.</span>
<span class="keyword">end</span>
<span class="ident">out</span><span class="symbol">.</span><span class="symbol">close</span><span class="symbol">(</span><span class="symbol">)</span><span class="symbol"></span></pre></li></ul><h3>See also</h3><ul><li><strong><a href="../guide/speaker_audio.html" class="reference"><code>Playing audio with speakers</code></a></strong> Gives a more general introduction to audio processing and the speaker.</li><li><strong><span class="reference reference-unresolved"><code>speaker.playAudio</code></span></strong> To play the decoded audio data.</li></ul><h3>Changes</h3><ul><li><strong>New in version 1.100.0</strong> </li></ul><table class="definition-list"><tr><th class="definition-name"><a href="#v:make_encoder">make_encoder()</a></th><td>Create a new encoder for converting PCM audio data into DFPWM.</td></tr><tr><th class="definition-name"><a href="#v:encode">encode(input)</a></th><td>A convenience function for encoding a complete file of audio at once.</td></tr><tr><th class="definition-name"><a href="#v:make_decoder">make_decoder()</a></th><td>Create a new decoder for converting DFPWM into PCM audio data.</td></tr><tr><th class="definition-name"><a href="#v:decode">decode(input)</a></th><td>A convenience function for decoding a complete file of audio at once.</td></tr></table><dl class="definition"><dt><a name="v:make_encoder" href="#v:make_encoder"></a><span class="definition-name">make_encoder()</span><a href="https://github.com/cc-tweaked/CC-Tweaked/blob/cdeb72514acfbc1fb67cceddc0ce26738f52c5b7/projects/core/src/main/resources/data/computercraft/lua/rom/modules/main/cc/audio/dfpwm.lua#L105" class="source-link">Source</a></dt><dd><p>Create a new encoder for converting PCM audio data into DFPWM.</p>
<p>The returned encoder is itself a function. This function accepts a table of amplitude data between -128 and 127 and
returns the encoded DFPWM data.</p>
<div class="admonition admonition-warning"><h5 class="admonition-heading"><span aria-hidden="true">⚠</span> Reusing encoders</h5><p>Encoders have lots of internal state which tracks the state of the current stream. If you reuse an encoder for multiple
streams, or use different encoders for the same stream, the resulting audio may not sound correct.</p>
</div><h3>Returns</h3><ol class="return-list"><li><span class="type">function(pcm: { <span class="reference reference-unresolved"><code>number</code></span>... }):<a href="https://www.lua.org/manual/5.1/manual.html#5.4" class="reference"><code>string</code></a></span> The encoder function</li></ol><h3>See also</h3><ul><li><strong><a href="cc.audio.dfpwm.html#v:encode" class="reference"><code>encode</code></a></strong> A helper function for encoding an entire file of audio at once.</li></ul></dd><dt><a name="v:encode" href="#v:encode"></a><span class="definition-name">encode(input)</span><a href="https://github.com/cc-tweaked/CC-Tweaked/blob/cdeb72514acfbc1fb67cceddc0ce26738f52c5b7/projects/core/src/main/resources/data/computercraft/lua/rom/modules/main/cc/audio/dfpwm.lua#L221" class="source-link">Source</a></dt><dd><p>A convenience function for encoding a complete file of audio at once.</p>
<p>This should only be used for complete pieces of audio. If you are writing writing multiple chunks to the same place,
you should use an encoder returned by <a href="cc.audio.dfpwm.html#v:make_encoder" class="reference"><code>make_encoder</code></a> instead.</p>
<h3>Parameters</h3><ol class="parameter-list"><li><span class="parameter">input</span> <span class="type">{ <span class="reference reference-unresolved"><code>number</code></span>... }</span> The table of amplitude data.</li></ol><h3>Returns</h3><ol class="return-list"><li><span class="type"><a href="https://www.lua.org/manual/5.1/manual.html#5.4" class="reference"><code>string</code></a></span> The encoded DFPWM data.</li></ol><h3>See also</h3><ul><li><strong><a href="cc.audio.dfpwm.html#v:make_encoder" class="reference"><code>make_encoder</code></a></strong> </li></ul></dd><dt><a name="v:make_decoder" href="#v:make_decoder"></a><span class="definition-name">make_decoder()</span><a href="https://github.com/cc-tweaked/CC-Tweaked/blob/cdeb72514acfbc1fb67cceddc0ce26738f52c5b7/projects/core/src/main/resources/data/computercraft/lua/rom/modules/main/cc/audio/dfpwm.lua#L163" class="source-link">Source</a></dt><dd><p>Create a new decoder for converting DFPWM into PCM audio data.</p>
<p>The returned decoder is itself a function. This function accepts a string and returns a table of amplitudes, each value
between -128 and 127.</p>
<div class="admonition admonition-warning"><h5 class="admonition-heading"><span aria-hidden="true">⚠</span> Reusing decoders</h5><p>Decoders have lots of internal state which tracks the state of the current stream. If you reuse an decoder for
multiple streams, or use different decoders for the same stream, the resulting audio may not sound correct.</p>
</div><h3>Returns</h3><ol class="return-list"><li><span class="type">function(dfpwm: <a href="https://www.lua.org/manual/5.1/manual.html#5.4" class="reference"><code>string</code></a>):{ <span class="reference reference-unresolved"><code>number</code></span>... }</span> The encoder function</li></ol><h3>Usage</h3><ul><li><p>Reads &quot;data/example.dfpwm&quot; in blocks of 16KiB (the speaker can accept a maximum of 128×1024 samples), decodes
them and then plays them through the speaker.</p>
<pre class="highlight" data-lua-kind="stmt" data-peripheral="speaker"><span class="keyword">local</span> <a title="Convert between streams of DFPWM audio data and a list of amplitudes." href="cc.audio.dfpwm.html"><span class="ident">dfpwm</span> </a><span class="symbol">=</span> <span class="ident">require</span> <span class="string">"cc.audio.dfpwm"</span>
<span class="keyword">local</span> <span class="ident">speaker</span> <span class="symbol">=</span> <a title="Find all peripherals of a specific type, and return the wrapped peripherals." href="../module/peripheral.html#v:find"><span class="ident">peripheral</span><span class="symbol">.</span><span class="symbol">find</span></a><span class="symbol">(</span><span class="string">"speaker"</span><span class="symbol">)</span>

<span class="keyword">local</span> <span class="ident">decoder</span> <span class="symbol">=</span> <a title="Create a new decoder for converting DFPWM into PCM audio data." href="cc.audio.dfpwm.html#v:make_decoder"><span class="ident">dfpwm</span><span class="symbol">.</span><span class="symbol">make_decoder</span></a><span class="symbol">(</span><span class="symbol">)</span>
<span class="keyword">for</span> <span class="ident">input</span> <span class="keyword">in</span> <a title="Opens the given file name in read mode and returns an iterator that, each time it is called, returns a new line from the file." href="../module/io.html#v:lines"><span class="ident">io</span><span class="symbol">.</span><span class="symbol">lines</span></a><span class="symbol">(</span><span class="string">"data/example.dfpwm"</span><span class="symbol">,</span> <span class="number">16</span> <span class="symbol">*</span> <span class="number">1024</span><span class="symbol">)</span> <span class="keyword">do</span>
  <span class="keyword">local</span> <span class="ident">decoded</span> <span class="symbol">=</span> <span class="ident">decoder</span><span class="symbol">(</span><span class="ident">input</span><span class="symbol">)</span>
  <span class="keyword">while</span> <span class="operator-kw">not</span> <span class="ident">speaker</span><span class="symbol">.</span><span class="symbol">playAudio</span><span class="symbol">(</span><span class="ident">decoded</span><span class="symbol">)</span> <span class="keyword">do</span>
<a title="Pause execution of the current thread and waits for any events matching filter." href="../module/os.html#v:pullEvent">    <span class="ident">os</span><span class="symbol">.</span><span class="symbol">pullEvent</span></a><span class="symbol">(</span><span class="string">"speaker_audio_empty"</span><span class="symbol">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span><span class="symbol"></span></pre></li></ul><h3>See also</h3><ul><li><strong><a href="cc.audio.dfpwm.html#v:decode" class="reference"><code>decode</code></a></strong> A helper function for decoding an entire file of audio at once.</li></ul></dd><dt><a name="v:decode" href="#v:decode"></a><span class="definition-name">decode(input)</span><a href="https://github.com/cc-tweaked/CC-Tweaked/blob/cdeb72514acfbc1fb67cceddc0ce26738f52c5b7/projects/core/src/main/resources/data/computercraft/lua/rom/modules/main/cc/audio/dfpwm.lua#L207" class="source-link">Source</a></dt><dd><p>A convenience function for decoding a complete file of audio at once.</p>
<p>This should only be used for short files. For larger files, one should read the file in chunks and process it using
<a href="cc.audio.dfpwm.html#v:make_decoder" class="reference"><code>make_decoder</code></a>.</p>
<h3>Parameters</h3><ol class="parameter-list"><li><span class="parameter">input</span> <span class="type"><a href="https://www.lua.org/manual/5.1/manual.html#5.4" class="reference"><code>string</code></a></span> The DFPWM data to convert.</li></ol><h3>Returns</h3><ol class="return-list"><li><span class="type">{ <span class="reference reference-unresolved"><code>number</code></span>... }</span> The produced amplitude data.</li></ol><h3>See also</h3><ul><li><strong><a href="cc.audio.dfpwm.html#v:make_decoder" class="reference"><code>make_decoder</code></a></strong> </li></ul></dd></dl></section><footer>Last updated on 2023-10-11</footer></div><div id="search-overlay"></div><script src="../main.js?v=f449c6d1" type="text/javascript" defer=""></script></body></html>