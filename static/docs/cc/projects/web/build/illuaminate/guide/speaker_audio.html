<!DOCTYPE html><html><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Playing audio with speakers</title><meta property="og:title" content="Playing audio with speakers" /><meta property="og:type" content="website" /><meta name="description" content="CC: Tweaked's speaker peripheral provides a powerful way to play any audio you like with the speaker.playAudio method." /><meta property="og:description" content="CC: Tweaked's speaker peripheral provides a powerful way to play any audio you like with the speaker.playAudio method." /><meta property="og:image" content="https://devvie.cc/docs/cc/pack.png" /><meta property="og:site_name" content="CC: Tweaked" /><meta name="illuaminate:index" content="../index.json" /><link rel="stylesheet" href="../main.css?v=5ab962eb" type="text/css" /><!--
SPDX-FileCopyrightText: 2020 The CC: Tweaked Developers

SPDX-License-Identifier: MPL-2.0
-->

<meta name="theme-color" content="#c8d87c"></head><body><nav id="nav"><button id="nav-reveal" type="button">&#9776;</button><h1><a href=".././"><img src="../pack.png" alt="CC: Tweaked" /></a></h1><div class="nav-links"><h2 class="collapsed" tabindex="0">Globals</h2><ul><li><a href="../module/_G.html" class="sidebar-link">_G</a></li><li><a href="../module/colors.html" class="sidebar-link">colors</a></li><li><a href="../module/colours.html" class="sidebar-link">colours</a></li><li><a href="../module/commands.html" class="sidebar-link">commands</a></li><li><a href="../module/disk.html" class="sidebar-link">disk</a></li><li><a href="../module/fs.html" class="sidebar-link">fs</a></li><li><a href="../module/gps.html" class="sidebar-link">gps</a></li><li><a href="../module/help.html" class="sidebar-link">help</a></li><li><a href="../module/http.html" class="sidebar-link">http</a></li><li><a href="../module/io.html" class="sidebar-link">io</a></li><li><a href="../module/keys.html" class="sidebar-link">keys</a></li><li><a href="../module/multishell.html" class="sidebar-link">multishell</a></li><li><a href="../module/os.html" class="sidebar-link">os</a></li><li><a href="../module/paintutils.html" class="sidebar-link">paintutils</a></li><li><a href="../module/parallel.html" class="sidebar-link">parallel</a></li><li><a href="../module/peripheral.html" class="sidebar-link">peripheral</a></li><li><a href="../module/rednet.html" class="sidebar-link">rednet</a></li><li><a href="../module/settings.html" class="sidebar-link">settings</a></li><li><a href="../module/shell.html" class="sidebar-link">shell</a></li><li><a href="../module/term.html" class="sidebar-link">term</a></li><li><a href="../module/textutils.html" class="sidebar-link">textutils</a></li><li><a href="../module/turtle.html" class="sidebar-link">turtle</a></li><li><a href="../module/vector.html" class="sidebar-link">vector</a></li><li><a href="../module/window.html" class="sidebar-link">window</a></li></ul><h2 class="collapsed" tabindex="0">Modules</h2><ul><li><a href="../library/cc.audio.dfpwm.html" class="sidebar-link">cc.audio.dfpwm</a></li><li><a href="../library/cc.completion.html" class="sidebar-link">cc.completion</a></li><li><a href="../library/cc.expect.html" class="sidebar-link">cc.expect</a></li><li><a href="../library/cc.image.nft.html" class="sidebar-link">cc.image.nft</a></li><li><a href="../library/cc.pretty.html" class="sidebar-link">cc.pretty</a></li><li><a href="../library/cc.require.html" class="sidebar-link">cc.require</a></li><li><a href="../library/cc.shell.completion.html" class="sidebar-link">cc.shell.completion</a></li><li><a href="../library/cc.strings.html" class="sidebar-link">cc.strings</a></li></ul><h2 class="collapsed" tabindex="0">Events</h2><ul><li><a href="../event/alarm.html" class="sidebar-link">alarm</a></li><li><a href="../event/char.html" class="sidebar-link">char</a></li><li><a href="../event/computer_command.html" class="sidebar-link">computer_command</a></li><li><a href="../event/disk.html" class="sidebar-link">disk</a></li><li><a href="../event/disk_eject.html" class="sidebar-link">disk_eject</a></li><li><a href="../event/file_transfer.html" class="sidebar-link">file_transfer</a></li><li><a href="../event/http_check.html" class="sidebar-link">http_check</a></li><li><a href="../event/http_failure.html" class="sidebar-link">http_failure</a></li><li><a href="../event/http_success.html" class="sidebar-link">http_success</a></li><li><a href="../event/key.html" class="sidebar-link">key</a></li><li><a href="../event/key_up.html" class="sidebar-link">key_up</a></li><li><a href="../event/modem_message.html" class="sidebar-link">modem_message</a></li><li><a href="../event/monitor_resize.html" class="sidebar-link">monitor_resize</a></li><li><a href="../event/monitor_touch.html" class="sidebar-link">monitor_touch</a></li><li><a href="../event/mouse_click.html" class="sidebar-link">mouse_click</a></li><li><a href="../event/mouse_drag.html" class="sidebar-link">mouse_drag</a></li><li><a href="../event/mouse_scroll.html" class="sidebar-link">mouse_scroll</a></li><li><a href="../event/mouse_up.html" class="sidebar-link">mouse_up</a></li><li><a href="../event/paste.html" class="sidebar-link">paste</a></li><li><a href="../event/peripheral.html" class="sidebar-link">peripheral</a></li><li><a href="../event/peripheral_detach.html" class="sidebar-link">peripheral_detach</a></li><li><a href="../event/rednet_message.html" class="sidebar-link">rednet_message</a></li><li><a href="../event/redstone.html" class="sidebar-link">redstone</a></li><li><a href="../event/speaker_audio_empty.html" class="sidebar-link">speaker_audio_empty</a></li><li><a href="../event/task_complete.html" class="sidebar-link">task_complete</a></li><li><a href="../event/term_resize.html" class="sidebar-link">term_resize</a></li><li><a href="../event/terminate.html" class="sidebar-link">terminate</a></li><li><a href="../event/timer.html" class="sidebar-link">timer</a></li><li><a href="../event/turtle_inventory.html" class="sidebar-link">turtle_inventory</a></li><li><a href="../event/websocket_closed.html" class="sidebar-link">websocket_closed</a></li><li><a href="../event/websocket_failure.html" class="sidebar-link">websocket_failure</a></li><li><a href="../event/websocket_message.html" class="sidebar-link">websocket_message</a></li><li><a href="../event/websocket_success.html" class="sidebar-link">websocket_success</a></li></ul><h2 tabindex="0">Guides</h2><ul><li><a href="gps_setup.html" class="sidebar-link">Setting up GPS</a></li><li><a href="local_ips.html" class="sidebar-link">Allowing access to local IPs</a></li><li><strong class="sidebar-link selected">Playing audio with speakers</strong></li><li><a href="using_require.html" class="sidebar-link">Reusing code with require</a></li></ul><h2 class="collapsed" tabindex="0">Reference</h2><ul><li><a href="../reference/feature_compat.html" class="sidebar-link">Lua 5.2/5.3 features in CC: Tweaked</a></li></ul></div></nav><div id="main"><div id="search-form" role="form"><input id="search-box" type="text" placeholder="Search..." autocomplete="off" tabindex="0"></input><div id="search-results"></div></div><section id="content"><h1>Playing audio with speakers</h1><!--
SPDX-FileCopyrightText: 2021 The CC: Tweaked Developers

SPDX-License-Identifier: MPL-2.0
-->
<p>CC: Tweaked's speaker peripheral provides a powerful way to play any audio you like with the <span class="reference reference-unresolved"><code>speaker.playAudio</code></span>
method. However, for people unfamiliar with digital audio, it's not the most intuitive thing to use. This guide provides
an introduction to digital audio, demonstrates how to play music with CC: Tweaked's speakers, and then briefly discusses
the more complex topic of audio processing.</p>
<h2>A short introduction to digital audio</h2>
<p>When sound is recorded it is captured as an analogue signal, effectively the electrical version of a sound
wave. However, this signal is continuous, and so can't be used directly by a computer. Instead, we measure (or <em>sample</em>)
the amplitude of the wave many times a second and then <em>quantise</em> that amplitude, rounding it to the nearest
representable value.</p>
<p>This representation of sound - a long, uniformally sampled list of amplitudes is referred to as <a href="https://en.wikipedia.org/wiki/Pulse-code_modulation" title="Pulse-code Modulation - Wikipedia">Pulse-code
Modulation</a> (PCM). PCM can be thought of as the &quot;standard&quot; audio format, as it's incredibly easy to work with. For
instance, to mix two pieces of audio together, you can just add samples from the two tracks together and take the average.</p>
<p>CC: Tweaked's speakers also work with PCM audio. It plays back 48,000 samples a second, where each sample is an integer
between -128 and 127. This is more commonly referred to as 48kHz and an 8-bit resolution.</p>
<p>Let's now look at a quick example. We're going to generate a <a href="https://en.wikipedia.org/wiki/Sine_wave" title="Sine wave - Wikipedia">Sine Wave</a> at 220Hz, which sounds like a low monotonous
hum. First we wrap our speaker peripheral, and then we fill a table (also referred to as a <em>buffer</em>) with 128Ã—1024
samples - this is the maximum number of samples a speaker can accept in one go.</p>
<p>In order to fill this buffer, we need to do a little maths. We want to play 220 sine waves each second, where each sine
wave completes a full oscillation in 2Ï€ &quot;units&quot;. This means one seconds worth of audio is 2Ã—Ï€Ã—220 &quot;units&quot; long. We then
need to split this into 48k samples, basically meaning for each sample we move 2Ã—Ï€Ã—220/48k &quot;along&quot; the sine curve.</p>
<pre class="highlight" data-lua-kind="stmt" data-peripheral="speaker"><span class="keyword">local</span> <span class="ident">speaker</span> <span class="symbol">=</span> <a title="Find all peripherals of a specific type, and return the wrapped peripherals." href="../module/peripheral.html#v:find"><span class="ident">peripheral</span><span class="symbol">.</span><span class="symbol">find</span></a><span class="symbol">(</span><span class="string">"speaker"</span><span class="symbol">)</span>

<span class="keyword">local</span> <span class="ident">buffer</span> <span class="symbol">=</span> <span class="symbol">{</span><span class="symbol">}</span>
<span class="keyword">local</span> <span class="ident">t</span><span class="symbol">,</span> <span class="ident">dt</span> <span class="symbol">=</span> <span class="number">0</span><span class="symbol">,</span> <span class="number">2</span> <span class="symbol">*</span> <span class="ident">math</span><span class="symbol">.</span><span class="symbol">pi</span> <span class="symbol">*</span> <span class="number">220</span> <span class="symbol">/</span> <span class="number">48000</span>
<span class="keyword">for</span> <span class="ident">i</span> <span class="symbol">=</span> <span class="number">1</span><span class="symbol">,</span> <span class="number">128</span> <span class="symbol">*</span> <span class="number">1024</span> <span class="keyword">do</span>
    <span class="ident">buffer</span><span class="symbol">[</span><span class="ident">i</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="ident">math</span><span class="symbol">.</span><span class="symbol">floor</span><span class="symbol">(</span><span class="ident">math</span><span class="symbol">.</span><span class="symbol">sin</span><span class="symbol">(</span><span class="ident">t</span><span class="symbol">)</span> <span class="symbol">*</span> <span class="number">127</span><span class="symbol">)</span>
    <span class="ident">t</span> <span class="symbol">=</span> <span class="symbol">(</span><span class="ident">t</span> <span class="symbol">+</span> <span class="ident">dt</span><span class="symbol">)</span> <span class="symbol">%</span> <span class="symbol">(</span><span class="ident">math</span><span class="symbol">.</span><span class="symbol">pi</span> <span class="symbol">*</span> <span class="number">2</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="ident">speaker</span><span class="symbol">.</span><span class="symbol">playAudio</span><span class="symbol">(</span><span class="ident">buffer</span><span class="symbol">)</span><span class="symbol"></span></pre><h2>Streaming audio</h2>
<p>You might notice that the above snippet only generates a short bit of audio - 2.7s seconds to be precise. While we could
try increasing the number of loop iterations, we'll get an error when we try to play it through the speaker: the sound
buffer is too large for it to handle.</p>
<p>Our 2.7 seconds of audio is stored in a table with over 130 <em>thousand</em> elements. If we wanted to play a full minute of
sine waves (and why wouldn't you?), you'd need a table with almost 3 <em>million</em>. Suddenly you find these numbers adding
up very quickly, and these tables take up more and more memory.</p>
<p>Instead of building our entire song (well, sine wave) in one go, we can produce it in small batches, each of which get
passed off to <span class="reference reference-unresolved"><code>speaker.playAudio</code></span> when the time is right. This allows us to build a <em>stream</em> of audio, where we read
chunks of audio one at a time (either from a file or a tone generator like above), do some optional processing to each
one, and then play them.</p>
<p>Let's adapt our example from above to do that instead.</p>
<pre class="highlight" data-lua-kind="stmt" data-peripheral="speaker"><span class="keyword">local</span> <span class="ident">speaker</span> <span class="symbol">=</span> <a title="Find all peripherals of a specific type, and return the wrapped peripherals." href="../module/peripheral.html#v:find"><span class="ident">peripheral</span><span class="symbol">.</span><span class="symbol">find</span></a><span class="symbol">(</span><span class="string">"speaker"</span><span class="symbol">)</span>

<span class="keyword">local</span> <span class="ident">t</span><span class="symbol">,</span> <span class="ident">dt</span> <span class="symbol">=</span> <span class="number">0</span><span class="symbol">,</span> <span class="number">2</span> <span class="symbol">*</span> <span class="ident">math</span><span class="symbol">.</span><span class="symbol">pi</span> <span class="symbol">*</span> <span class="number">220</span> <span class="symbol">/</span> <span class="number">48000</span>
<span class="keyword">while</span> <span class="literal-kw">true</span> <span class="keyword">do</span>
    <span class="keyword">local</span> <span class="ident">buffer</span> <span class="symbol">=</span> <span class="symbol">{</span><span class="symbol">}</span>
    <span class="keyword">for</span> <span class="ident">i</span> <span class="symbol">=</span> <span class="number">1</span><span class="symbol">,</span> <span class="number">16</span> <span class="symbol">*</span> <span class="number">1024</span> <span class="symbol">*</span> <span class="number">8</span> <span class="keyword">do</span>
        <span class="ident">buffer</span><span class="symbol">[</span><span class="ident">i</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="ident">math</span><span class="symbol">.</span><span class="symbol">floor</span><span class="symbol">(</span><span class="ident">math</span><span class="symbol">.</span><span class="symbol">sin</span><span class="symbol">(</span><span class="ident">t</span><span class="symbol">)</span> <span class="symbol">*</span> <span class="number">127</span><span class="symbol">)</span>
        <span class="ident">t</span> <span class="symbol">=</span> <span class="symbol">(</span><span class="ident">t</span> <span class="symbol">+</span> <span class="ident">dt</span><span class="symbol">)</span> <span class="symbol">%</span> <span class="symbol">(</span><span class="ident">math</span><span class="symbol">.</span><span class="symbol">pi</span> <span class="symbol">*</span> <span class="number">2</span><span class="symbol">)</span>
    <span class="keyword">end</span>

    <span class="keyword">while</span> <span class="operator-kw">not</span> <span class="ident">speaker</span><span class="symbol">.</span><span class="symbol">playAudio</span><span class="symbol">(</span><span class="ident">buffer</span><span class="symbol">)</span> <span class="keyword">do</span>
<a title="Pause execution of the current thread and waits for any events matching filter." href="../module/os.html#v:pullEvent">        <span class="ident">os</span><span class="symbol">.</span><span class="symbol">pullEvent</span></a><span class="symbol">(</span><span class="string">"speaker_audio_empty"</span><span class="symbol">)</span>
    <span class="keyword">end</span>
<span class="keyword">end</span><span class="symbol"></span></pre><p>It looks pretty similar to before, aside from we've wrapped the generation and playing code in a while loop, and added a
rather odd loop with <span class="reference reference-unresolved"><code>speaker.playAudio</code></span> and <a href="../module/os.html#v:pullEvent" class="reference"><code>os.pullEvent</code></a>.</p>
<p>Let's talk about this loop, why do we need to keep calling <span class="reference reference-unresolved"><code>speaker.playAudio</code></span>? Remember that what we're trying to do
here is avoid keeping too much audio in memory at once. However, if we're generating audio quicker than the speakers can
play it, we're not helping at all - all this audio is still hanging around waiting to be played!</p>
<p>In order to avoid this, the speaker rejects any new chunks of audio if its backlog is too large. When this happens,
<span class="reference reference-unresolved"><code>speaker.playAudio</code></span> returns false. Once enough audio has played, and the backlog has been reduced, a
<a href="../event/speaker_audio_empty.html" class="reference"><code>speaker_audio_empty</code></a> event is queued, and we can try to play our chunk once more.</p>
<h2>Storing audio</h2>
<p>PCM is a fantastic way of representing audio when we want to manipulate it, but it's not very efficient when we want to
store it to disk. Compare the size of a WAV file (which uses PCM) to an equivalent MP3, it's often 5 times the size.
Instead, we store audio in special formats (or <em>codecs</em>) and then convert them to PCM when we need to do processing on
them.</p>
<p>Modern audio codecs use some incredibly impressive techniques to compress the audio as much as possible while preserving
sound quality. However, due to CC: Tweaked's limited processing power, it's not really possible to use these from your
computer. Instead, we need something much simpler.</p>
<p>DFPWM (Dynamic Filter Pulse Width Modulation) is the de facto standard audio format of the ComputerCraft (and
OpenComputers) world. Originally popularised by the addon mod <a href="https://github.com/Vexatos/Computronics/" title="Computronics on GitHub">Computronics</a>, CC:T now has built-in support for it with
the <a href="../library/cc.audio.dfpwm.html" class="reference"><code>cc.audio.dfpwm</code></a> module. This allows you to read DFPWM files from disk, decode them to PCM, and then play them
using the speaker.</p>
<p>Let's dive in with an example, and we'll explain things afterwards:</p>
<pre class="highlight" data-lua-kind="stmt" data-peripheral="speaker"><span class="keyword">local</span> <a title="Convert between streams of DFPWM audio data and a list of amplitudes." href="../library/cc.audio.dfpwm.html"><span class="ident">dfpwm</span> </a><span class="symbol">=</span> <span class="ident">require</span><span class="symbol">(</span><span class="string">"cc.audio.dfpwm"</span><span class="symbol">)</span>
<span class="keyword">local</span> <span class="ident">speaker</span> <span class="symbol">=</span> <a title="Find all peripherals of a specific type, and return the wrapped peripherals." href="../module/peripheral.html#v:find"><span class="ident">peripheral</span><span class="symbol">.</span><span class="symbol">find</span></a><span class="symbol">(</span><span class="string">"speaker"</span><span class="symbol">)</span>

<span class="keyword">local</span> <span class="ident">decoder</span> <span class="symbol">=</span> <a title="Create a new decoder for converting DFPWM into PCM audio data." href="../library/cc.audio.dfpwm.html#v:make_decoder"><span class="ident">dfpwm</span><span class="symbol">.</span><span class="symbol">make_decoder</span></a><span class="symbol">(</span><span class="symbol">)</span>
<span class="keyword">for</span> <span class="ident">chunk</span> <span class="keyword">in</span> <a title="Opens the given file name in read mode and returns an iterator that, each time it is called, returns a new line from the file." href="../module/io.html#v:lines"><span class="ident">io</span><span class="symbol">.</span><span class="symbol">lines</span></a><span class="symbol">(</span><span class="string">"data/example.dfpwm"</span><span class="symbol">,</span> <span class="number">16</span> <span class="symbol">*</span> <span class="number">1024</span><span class="symbol">)</span> <span class="keyword">do</span>
    <span class="keyword">local</span> <span class="ident">buffer</span> <span class="symbol">=</span> <span class="ident">decoder</span><span class="symbol">(</span><span class="ident">chunk</span><span class="symbol">)</span>

    <span class="keyword">while</span> <span class="operator-kw">not</span> <span class="ident">speaker</span><span class="symbol">.</span><span class="symbol">playAudio</span><span class="symbol">(</span><span class="ident">buffer</span><span class="symbol">)</span> <span class="keyword">do</span>
<a title="Pause execution of the current thread and waits for any events matching filter." href="../module/os.html#v:pullEvent">        <span class="ident">os</span><span class="symbol">.</span><span class="symbol">pullEvent</span></a><span class="symbol">(</span><span class="string">"speaker_audio_empty"</span><span class="symbol">)</span>
    <span class="keyword">end</span>
<span class="keyword">end</span><span class="symbol"></span></pre><p>Once again, we see the <span class="reference reference-unresolved"><code>speaker.playAudio</code></span>/<a href="../event/speaker_audio_empty.html" class="reference"><code>speaker_audio_empty</code></a> loop. However, the rest of the program is a little
different.</p>
<p>First, we require the dfpwm module and call <a href="../library/cc.audio.dfpwm.html#v:make_decoder" class="reference"><code>cc.audio.dfpwm.make_decoder</code></a> to construct a new decoder. This decoder
accepts blocks of DFPWM data and converts it to a list of 8-bit amplitudes, which we can then play with our speaker.</p>
<p>As mentioned above, <span class="reference reference-unresolved"><code>speaker.playAudio</code></span> accepts at most 128Ã—1024 samples in one go. DFPMW uses a single bit for each
sample, which means we want to process our audio in chunks of 16Ã—1024 bytes (16KiB). In order to do this, we use
<a href="../module/io.html#v:lines" class="reference"><code>io.lines</code></a>, which provides a nice way to loop over chunks of a file. You can of course just use <span class="reference reference-unresolved"><code>fs.open</code></span> and
<span class="reference reference-unresolved"><code>fs.BinaryReadHandle.read</code></span> if you prefer.</p>
<h2>Processing audio</h2>
<p>As mentioned near the beginning of this guide, PCM audio is pretty easy to work with as it's just a list of amplitudes.
You can mix together samples from different streams by adding their amplitudes, change the rate of playback by removing
samples, etc...</p>
<p>Let's put together a small demonstration here. We're going to add a small delay effect to the song above, so that you
hear a faint echo a second and a half later.</p>
<p>In order to do this, we'll follow a format similar to the previous example, decoding the audio and then playing it.
However, we'll also add some new logic between those two steps, which loops over every sample in our chunk of audio, and
adds the sample from 1.5 seconds ago to it.</p>
<p>For this, we'll need to keep track of the last 72k samples - exactly 1.5 seconds worth of audio. We can do this using a
<a href="https://en.wikipedia.org/wiki/Circular_buffer" title="Circular buffer - Wikipedia">Ring Buffer</a>, which helps makes things a little more efficient.</p>
<pre class="highlight" data-lua-kind="stmt" data-peripheral="speaker"><span class="keyword">local</span> <a title="Convert between streams of DFPWM audio data and a list of amplitudes." href="../library/cc.audio.dfpwm.html"><span class="ident">dfpwm</span> </a><span class="symbol">=</span> <span class="ident">require</span><span class="symbol">(</span><span class="string">"cc.audio.dfpwm"</span><span class="symbol">)</span>
<span class="keyword">local</span> <span class="ident">speaker</span> <span class="symbol">=</span> <a title="Find all peripherals of a specific type, and return the wrapped peripherals." href="../module/peripheral.html#v:find"><span class="ident">peripheral</span><span class="symbol">.</span><span class="symbol">find</span></a><span class="symbol">(</span><span class="string">"speaker"</span><span class="symbol">)</span>

<span class="comment">-- Speakers play at 48kHz, so 1.5 seconds is 72k samples. We first fill our buffer</span>
<span class="comment">-- with 0s, as there's nothing to echo at the start of the track!</span>
<span class="keyword">local</span> <span class="ident">samples_i</span><span class="symbol">,</span> <span class="ident">samples_n</span> <span class="symbol">=</span> <span class="number">1</span><span class="symbol">,</span> <span class="number">48000</span> <span class="symbol">*</span> <span class="number">1.5</span>
<span class="keyword">local</span> <span class="ident">samples</span> <span class="symbol">=</span> <span class="symbol">{</span><span class="symbol">}</span>
<span class="keyword">for</span> <span class="ident">i</span> <span class="symbol">=</span> <span class="number">1</span><span class="symbol">,</span> <span class="ident">samples_n</span> <span class="keyword">do</span> <span class="ident">samples</span><span class="symbol">[</span><span class="ident">i</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="number">0</span> <span class="keyword">end</span>

<span class="keyword">local</span> <span class="ident">decoder</span> <span class="symbol">=</span> <a title="Create a new decoder for converting DFPWM into PCM audio data." href="../library/cc.audio.dfpwm.html#v:make_decoder"><span class="ident">dfpwm</span><span class="symbol">.</span><span class="symbol">make_decoder</span></a><span class="symbol">(</span><span class="symbol">)</span>
<span class="keyword">for</span> <span class="ident">chunk</span> <span class="keyword">in</span> <a title="Opens the given file name in read mode and returns an iterator that, each time it is called, returns a new line from the file." href="../module/io.html#v:lines"><span class="ident">io</span><span class="symbol">.</span><span class="symbol">lines</span></a><span class="symbol">(</span><span class="string">"data/example.dfpwm"</span><span class="symbol">,</span> <span class="number">16</span> <span class="symbol">*</span> <span class="number">1024</span><span class="symbol">)</span> <span class="keyword">do</span>
    <span class="keyword">local</span> <span class="ident">buffer</span> <span class="symbol">=</span> <span class="ident">decoder</span><span class="symbol">(</span><span class="ident">chunk</span><span class="symbol">)</span>

    <span class="keyword">for</span> <span class="ident">i</span> <span class="symbol">=</span> <span class="number">1</span><span class="symbol">,</span> <span class="symbol">#</span><span class="ident">buffer</span> <span class="keyword">do</span>
        <span class="keyword">local</span> <span class="ident">original_value</span> <span class="symbol">=</span> <span class="ident">buffer</span><span class="symbol">[</span><span class="ident">i</span><span class="symbol">]</span>

        <span class="comment">-- Replace this sample with its current amplitude plus the amplitude from 1.5 seconds ago.</span>
        <span class="comment">-- We scale both to ensure the resulting value is still between -128 and 127.</span>
        <span class="ident">buffer</span><span class="symbol">[</span><span class="ident">i</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="ident">original_value</span> <span class="symbol">*</span> <span class="number">0.6</span> <span class="symbol">+</span> <span class="ident">samples</span><span class="symbol">[</span><span class="ident">samples_i</span><span class="symbol">]</span> <span class="symbol">*</span> <span class="number">0.4</span>

        <span class="comment">-- Now store the current sample, and move the "head" of our ring buffer forward one place.</span>
        <span class="ident">samples</span><span class="symbol">[</span><span class="ident">samples_i</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="ident">original_value</span>
        <span class="ident">samples_i</span> <span class="symbol">=</span> <span class="ident">samples_i</span> <span class="symbol">+</span> <span class="number">1</span>
        <span class="keyword">if</span> <span class="ident">samples_i</span> <span class="symbol">></span> <span class="ident">samples_n</span> <span class="keyword">then</span> <span class="ident">samples_i</span> <span class="symbol">=</span> <span class="number">1</span> <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">while</span> <span class="operator-kw">not</span> <span class="ident">speaker</span><span class="symbol">.</span><span class="symbol">playAudio</span><span class="symbol">(</span><span class="ident">buffer</span><span class="symbol">)</span> <span class="keyword">do</span>
<a title="Pause execution of the current thread and waits for any events matching filter." href="../module/os.html#v:pullEvent">        <span class="ident">os</span><span class="symbol">.</span><span class="symbol">pullEvent</span></a><span class="symbol">(</span><span class="string">"speaker_audio_empty"</span><span class="symbol">)</span>
    <span class="keyword">end</span>

    <span class="comment">-- The audio processing above can be quite slow and preparing the first batch of audio</span>
    <span class="comment">-- may timeout the computer. We sleep to avoid this.</span>
    <span class="comment">-- There's definitely better ways of handling this - this is just an example!</span>
    <span class="ident">sleep</span><span class="symbol">(</span><span class="number">0.05</span><span class="symbol">)</span>
<span class="keyword">end</span><span class="symbol"></span></pre><div class="admonition admonition-note"><h5 class="admonition-heading"><span aria-hidden="true">ðŸ›ˆ</span> Confused?</h5><p>Don't worry if you don't understand this example. It's quite advanced, and does use some ideas that this guide doesn't
cover. That said, don't be afraid to ask on <a href="https://github.com/cc-tweaked/CC-Tweaked/discussions">GitHub Discussions</a> or <a href="https://webchat.esper.net/?channels=computercraft" title="#computercraft on EsperNet">IRC</a> either!</p>
</div><p>It's worth noting that the examples of audio processing we've mentioned here are about manipulating the <em>amplitude</em> of
the wave. If you wanted to modify the <em>frequency</em> (for instance, shifting the pitch), things get rather more complex.
For this, you'd need to use the <a href="https://en.wikipedia.org/wiki/Fast_Fourier_transform" title="Fast Fourier transform - Wikipedia">Fast Fourier transform</a> to convert the stream of amplitudes to frequencies,
process those, and then convert them back to amplitudes.</p>
<p>This is, I'm afraid, left as an exercise to the reader.</p>
<h3>See also</h3><ul><li><strong><span class="reference reference-unresolved"><code>speaker.playAudio</code></span></strong> Play PCM audio using a speaker.</li><li><strong><a href="../library/cc.audio.dfpwm.html" class="reference"><code>cc.audio.dfpwm</code></a></strong> Provides utilities for encoding and decoding DFPWM files.</li></ul></section><footer>Last updated on 2023-10-11</footer></div><div id="search-overlay"></div><script src="../main.js?v=f449c6d1" type="text/javascript" defer=""></script></body></html>